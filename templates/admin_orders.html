{% extends "base.html" %}
{% block title %}Admin - Stickerdom{% endblock %}
{% block content %}

<div class="container mt-4 mt-lg-5 p-2 p-lg-4 bg-light shadow-sm rounded"> 
    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
        <h1>Morning, sir!</h1>
    </div>

    {% if orders %}
    <section class="admin-orders-list">
        <ul class="list-group">
            {% for order in orders %}
    
            <li class="list-group-item p-3 border-0 shadow-sm mb-3 rounded"> 
                
                <div class="d-flex flex-column flex-lg-row gap-3 align-items-stretch align-items-lg-center">
                    
                    <div class="d-flex justify-content-between align-items-center" style="min-width: 200px;">
                        <span class="fw-bold fs-5">Order #{{order.id}}</span>
                        <span class="fw-bold fs-5 text-primary">€{{ '%.2f'|format(order.total_price)}}</span>
                    </div>

                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 flex-grow-1">
                        <span class="badge rounded-pill fs-6 px-3 py-2
                            {% if order.status == 'finished' %}bg-success text-white
                            {% elif order.status == 'cancelled' %}bg-danger text-white
                            {% elif order.status == 'confirmed' %}bg-primary text-white
                            {% elif order.status == 'pending' %}bg-warning text-dark
                            {% endif %}">
                            {{order.status}}
                        </span>

                        <div class="text-muted small d-flex flex-column ms-md-2 border-start ps-md-3 border-secondary-subtle">
                            <span>
                                <i class="bi bi-clock me-1"></i> 
                                {% if order.created_at %}
                                    {{ order.created_at.strftime('%d %b %H:%M') }}
                                {% else %}
                                    --
                                {% endif %}
                            </span>
                            {% if order.payment and order.payment.date %}
                            <span>
                                <i class="bi bi-geo-alt-fill me-1"></i> {{ order.payment.date }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between justify-content-lg-end gap-2 flex-wrap pt-2 pt-lg-0 border-top border-lg-0">
                        <div class="d-flex gap-1 flex-wrap">
                            {% set statuses = {
                                'pending': 'warning',
                                'confirmed': 'primary',
                                'finished': 'success',
                                'cancelled': 'danger'
                            } %}

                            {% for status, color in statuses.items() %}
                            <form method="POST"
                                action="{{ url_for('admin.update_order_status', order_id=order.id, new_status=status) }}">

                                <button class="btn btn-sm
                                    {% if order.status == status %}
                                        btn-{{ color }}
                                    {% else %}
                                        btn-outline-{{ color }}
                                    {% endif %}"
                                    type="submit"
                                    title="{{ status|capitalize }}">
                                    
                                    <span class="d-none d-lg-inline">{{ status|capitalize }}</span>
                                    <span class="d-inline d-lg-none fs-5 px-1">
                                        {% if status == 'pending' %} <i class="bi bi-hourglass-split"></i>
                                        {% elif status == 'confirmed' %} <i class="bi bi-check-lg"></i>
                                        {% elif status == 'finished' %} <i class="bi bi-box-seam-fill"></i>
                                        {% elif status == 'cancelled' %} <i class="bi bi-x-lg"></i>
                                        {% endif %}
                                    </span>
                                </button>
                            </form>
                            {% endfor %}
                        </div>

                        <button class="btn btn-light ms-auto ms-lg-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#orderDetail{{ order.id }}"
                                aria-expanded="false">
                            <i class="bi bi-caret-down-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="collapse mt-3" id="orderDetail{{ order.id }}">
                    <div class="card card-body bg-white border shadow-sm p-3">
                        
                        <div class="d-flex flex-column flex-md-row gap-4">
                            
                            <div class="flex-fill">
                                <h6 class="fw-bold text-dark border-bottom pb-2 mb-2">{{ _('Customer Details') }}</h6>
                                <div class="px-1">
                                    <p class="mb-0 fw-bold text-dark">{{order.payment.full_name}}</p>
                                    <small class="text-muted d-block text-break">{{order.payment.email}}</small>
                                </div>
                            </div>

                            <div class="flex-fill">
                                <h6 class="fw-bold text-dark border-bottom pb-2 mb-2">{{ _('Order contents') }}</h6>
                                <ul class="list-unstyled mb-0 px-1">
                                    {% for item in order.order_items %}
                                    <li class="d-flex justify-content-between align-items-center py-2 border-bottom-dashed text-dark">
                                        
                                        <div class="d-flex align-items-center overflow-hidden" style="min-width: 0;">
                                            <span class="text-truncate d-block">
                                                {{ item.sticker.name }} 
                                            </span>
                                            <span class="badge bg-light text-dark border ms-2 flex-shrink-0">x{{ item.quantity }}</span>
                                        </div>
                                        
                                        <span class="fw-bold text-nowrap ms-2">€{{ '%.2f'|format(item.price_at_time * item.quantity) }}</span>
                                    </li>
                                    {% else %}
                                    <li class="text-muted small py-2">
                                        <i class="bi bi-info-circle"></i> {{ _('No items found.') }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </li>
            {% endfor %}
            
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted display-1"></i>
                <h4 class="mt-3">{{ _('No orders found') }}</h4>
            </div>
            {% endif %}
        </ul>
    </section>
</div>

<style>
    .border-bottom-dashed { border-bottom: 1px dashed #e0e0e0; }
    .border-bottom-dashed:last-child { border-bottom: none; }
    
    /* Remove top borders on buttons for desktop */
    @media (min-width: 992px) {
        .border-lg-0 { border-top: 0 !important; }
    }

    .btn-primary {
    --bs-btn-color: #fff;
    --bs-btn-bg: #0d6efd;
    --bs-btn-border-color: #0d6efd;
    --bs-btn-hover-color: #fff;
    --bs-btn-hover-bg: #0b5ed7;
    --bs-btn-hover-border-color: #0a58ca;
    --bs-btn-focus-shadow-rgb: 49, 132, 253;
    --bs-btn-active-color: #fff;
    --bs-btn-active-bg: #0a58ca;
    --bs-btn-active-border-color: #0a53be;
    --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
    --bs-btn-disabled-color: #fff;
    --bs-btn-disabled-bg: #0d6efd;
    --bs-btn-disabled-border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0056b3;
    transform: translateY(1px);
    box-shadow: none;
}
</style>
{% endblock %}